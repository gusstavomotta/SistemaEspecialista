{% extends 'EscalaPoms/base.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/perfil.css' %}">
{% endblock %}

{% block title %}Meu Perfil{% endblock %}

{% block content %}
<section class="perfil">
  <header class="header">
    <h1>Meu Perfil</h1>
  </header>

  <form method="POST" enctype="multipart/form-data" id="form-perfil">
    {% csrf_token %}

    <div class="photo-field">
      {% if usuario.foto %}
        <img src="{{ usuario.foto.url }}" alt="Foto de {{ usuario.nome }}" class="photo-preview">
        <button type="submit" name="remove_foto" value="1" class="remove-photo-btn">Remover Foto</button>
      {% else %}
        <img src="{% static 'images/teste.png' %}" alt="Foto padrão" class="photo-preview">
        <input type="file" name="foto" accept="image/*">
      {% endif %}
    </div>

    <div class="profile-field">
      <span class="label">Nome:</span>
      <span class="value">{{ usuario.nome }}</span>
    </div>
    <div class="profile-field">
      <span class="label">Email:</span>
      <input type="email" name="email" value="{{ usuario.email }}" required>
    </div>
    <div class="profile-field">
      <span class="label">Telefone:</span>
      <input type="text" name="telefone" value="{{ usuario.num_telefone }}" required>
    </div>


    <div class="profile-actions" style="margin-top: 1em;">
      <a href="{% url 'solicitar_exclusao' %}" class="btn-danger">Excluir Conta</a>
      <button type="submit" class="btn-success">Salvar Perfil</button>
    </div>
  </form>

  {% if not usuario.treinador or not usuario.treinador.ativo %}
      {# Exibe alerta caso não haja treinador ativo #}
      <div class="alert alert-warning">
        Você ainda não possui um treinador ativo. Selecione um novo
      </div>
  {% endif %}
  {% if usuario.treinador.ativo %}
  <div class="profile-section" style="margin-top: 1.5em;">
    <h2 class="section-title">Treinador Atual</h2>

    <div class="profile-field">
      <span class="label">Nome:</span>
      <span class="value">{{ usuario.treinador.nome }}</span>
    </div>
    <div class="profile-field">
      <span class="label">Email:</span>
      <span class="value">{{ usuario.treinador.email }}</span>
    </div>
    <div class="profile-field">
      <span class="label">Telefone:</span>
      <span class="value">{{ usuario.treinador.num_telefone }}</span>
    </div>
  </div>
{% endif %}

{% if is_aluno %}
  <div class="profile-actions" style="margin-top: 1em;">
    <button type="button" id="mostrar-troca" class="btn-success">
      Trocar Treinador
    </button>
  </div>

  <div id="form-troca" style="display: none; margin-top: 1em;">
    {% if form_troca %}
      <form method="post">
        {% csrf_token %}

        <div class="profile-field">
          <label for="id_treinador" class="label">Novo Treinador:</label>
          {{ form_troca.treinador }}
          {% if form_troca.treinador.errors %}
            <div class="invalid-feedback d-block">
              {{ form_troca.treinador.errors.0 }}
            </div>
          {% endif %}
        </div>

        <div class="profile-actions" style="margin-top: .5em;">
          <!-- basta o name existir no POST -->
          <button type="submit" name="trocar_treinador" class="btn-primary">
            Confirmar Troca
          </button>
        </div>
      </form>
    {% endif %}
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const btn = document.getElementById('mostrar-troca');
      const formTroca = document.getElementById('form-troca');

      btn.addEventListener('click', function () {
        formTroca.style.display = 'block';
        btn.style.display  = 'none';
      });
    });
  </script>
{% endif %}
</section>
{% endblock %}
