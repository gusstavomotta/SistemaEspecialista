{% extends 'EscalaPoms/base.html' %}
{% load static %}

{% block extra_css %}
  <link rel="stylesheet" href="{% static 'css/perfil.css' %}">
{% endblock %}

{% block title %}Meu Perfil{% endblock %}

{% block content %}
<section class="perfil">
  <header class="header">
    <h1>Meu Perfil</h1>
  </header>

  <form method="POST" enctype="multipart/form-data" id="form-perfil">
    {% csrf_token %}

    <div class="photo-field">
      {% if usuario.foto %}
        <img src="{{ usuario.foto.url }}" alt="Foto de {{ usuario.nome }}" class="photo-preview">
        <button type="submit" name="remove_foto" value="1" class="remove-photo-btn">Remover Foto</button>
      {% else %}
        <img src="{% static 'images/teste.png' %}" alt="Foto padrão" class="photo-preview">
        <input type="file" name="foto" accept="image/*">
      {% endif %}
    </div>

    <div class="profile-field">
      <span class="label">CPF:</span>
      <span class="value">{{ usuario.cpf }}</span>
    </div>
    <div class="profile-field">
      <span class="label">Nome:</span>
      <span class="value">{{ usuario.nome }}</span>
    </div>
    <div class="profile-field">
      <span class="label">Email:</span>
      <input type="email" name="email" value="{{ usuario.email }}" required>
    </div>
    <div class="profile-field">
      <span class="label">Telefone:</span>
      <input type="text" name="telefone" value="{{ usuario.num_telefone }}" required>
    </div>
    <div class="profile-field">
      <span class="label">Gênero:</span>
      <span class="value">{{ usuario.genero }}</span>
    </div>

    <div class="profile-actions" style="margin-top: 1em;">
      <a href="{% url 'solicitar_exclusao' %}" class="btn-danger">Excluir Conta</a>
      <button type="submit" class="btn-success">Salvar Perfil</button>
    </div>
  </form>

  {% if usuario.treinador %}
  <div class="profile-section" style="margin-top: 1.5em;">
    <h1 class="section-title">Treinador Atual</h1>

    <div class="profile-field">
      <span class="label">Nome:</span>
      <span class="value">{{ usuario.treinador.nome }}</span>
    </div>
    <div class="profile-field">
      <span class="label">Email:</span>
      <span class="value">{{ usuario.treinador.email }}</span>
    </div>
    <div class="profile-field">
      <span class="label">Telefone:</span>
      <span class="value">{{ usuario.treinador.num_telefone }}</span>
    </div>
  </div>
{% endif %}

{% if is_aluno %}
<div class="profile-actions" style="margin-top: 1em;">
  <button type="button" id="mostrar-troca" class="btn-success">
    Trocar Treinador
  </button>
</div>

  <div id="form-troca" style="display: none; margin-top: 1em;">
    {% if form_troca %}

      <div class="profile-field">
        <span class="label">Novo Treinador:</span>
        <select name="treinador" required>
          <option value="" disabled {% if not usuario.treinador %}selected{% endif %}>Selecione…</option>
          {% for t in form_troca.fields.treinador.queryset %}
            <option value="{{ t.cpf }}"
              {% if usuario.treinador and usuario.treinador.cpf == t.cpf %}selected{% endif %}>
              {{ t.nome }}
            </option>
          {% endfor %}
        </select>
      </div>
      <div class="profile-actions" style="margin-top: .5em;">
        <button type="submit" name="trocar_treinador" class="btn-primary">
          Confirmar Troca
        </button>
      </div>
    {% endif %}
  </div>
{% endif %}

  {% if is_aluno %}
    <script>
      document.addEventListener('DOMContentLoaded', function () {
        const btn = document.getElementById('mostrar-troca');
        const formTroca = document.getElementById('form-troca');

        btn.addEventListener('click', function () {
          formTroca.style.display = 'block';
          btn.style.display      = 'none';
        });
      });
    </script>
  {% endif %}
</section>
{% endblock %}
